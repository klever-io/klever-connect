name: Publish Packages

# Manual publish workflow - publishes packages to npm
# Should be run AFTER versioning packages via "Version Packages" workflow
# Only triggered manually for security
on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write # For npm provenance

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Run tests
        run: pnpm test

      - name: Check NPM token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ NPM_TOKEN secret is not set"
            echo "Please add NPM_TOKEN to repository secrets"
            exit 1
          fi
          echo "âœ… NPM_TOKEN is configured"

      - name: Publish to npm
        run: pnpm publish -r --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Create Tag and GitHub Release
        run: |
          # Get version from main package
          VERSION=$(node -p "require('./packages/connect/package.json').version")

          # Skip if release already exists
          if gh release view "v$VERSION" > /dev/null 2>&1; then
            echo "Release v$VERSION already exists, skipping"
            exit 0
          fi

          # Create and push tag if it doesn't exist
          if ! git rev-parse "v$VERSION" > /dev/null 2>&1; then
            git tag "v$VERSION"
            git push origin "v$VERSION"
            echo "Created tag v$VERSION"
          fi

          # Create release
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --generate-notes \
            --verify-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Packages Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully published to npm!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ View on npm" >> $GITHUB_STEP_SUMMARY
          echo "- [@klever/connect](https://www.npmjs.com/package/@klever/connect)" >> $GITHUB_STEP_SUMMARY
